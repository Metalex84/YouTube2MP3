# Apache Virtual Host Configuration for YouTube2MP3
# Place this file in: /etc/apache2/sites-available/ (Debian/Ubuntu)
#                 or: /etc/httpd/conf.d/ (RedHat/CentOS)
#
# Enable site: sudo a2ensite youtube2mp3.conf
# Reload Apache: sudo systemctl reload apache2

<VirtualHost *:80>
    ServerName your-nas-hostname.local
    ServerAlias youtube2mp3.local
    
    # Optional: Redirect HTTP to HTTPS
    # Uncomment these lines if you have SSL configured
    # RewriteEngine On
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/youtube2mp3_error.log
    CustomLog ${APACHE_LOG_DIR}/youtube2mp3_access.log combined
    LogLevel warn
    
    # Document Root (for static files)
    DocumentRoot /opt/youtube2mp3
    
    # WSGI Configuration
    WSGIDaemonProcess youtube2mp3 \
        user=www-data \
        group=www-data \
        threads=5 \
        python-home=/opt/youtube2mp3/venv \
        python-path=/opt/youtube2mp3 \
        home=/opt/youtube2mp3
    
    WSGIProcessGroup youtube2mp3
    WSGIScriptAlias / /opt/youtube2mp3/wsgi.py
    
    # WebSocket Proxy Configuration (for SocketIO)
    # Requires: a2enmod proxy proxy_http proxy_wstunnel
    # Note: For production with WebSockets, consider using Gunicorn + systemd + Apache as reverse proxy
    ProxyPreserveHost On
    
    # Allow access to WSGI script
    <Directory /opt/youtube2mp3>
        Require all granted
    </Directory>
    
    # Static files (CSS, JS, images)
    Alias /static /opt/youtube2mp3/static
    <Directory /opt/youtube2mp3/static>
        Require all granted
        Options -Indexes
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </Directory>
    
    # Downloads directory (for serving MP3 files)
    Alias /downloads /opt/youtube2mp3/downloads
    <Directory /opt/youtube2mp3/downloads>
        Require all granted
        Options -Indexes
        # Limit file types to audio only
        <FilesMatch "\.(mp3|m4a|ogg|opus|zip)$">
            Require all granted
        </FilesMatch>
    </Directory>
    
    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    
    # Limit upload size (16MB)
    LimitRequestBody 16777216
</VirtualHost>

# HTTPS Configuration (optional but recommended)
# Requires SSL certificate - use Let's Encrypt with certbot
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName your-nas-hostname.local
    ServerAlias youtube2mp3.local
    
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/youtube2mp3.crt
    SSLCertificateKeyFile /etc/ssl/private/youtube2mp3.key
    # SSLCertificateChainFile /etc/ssl/certs/youtube2mp3-chain.crt
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/youtube2mp3_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/youtube2mp3_ssl_access.log combined
    LogLevel warn
    
    # Document Root
    DocumentRoot /opt/youtube2mp3
    
    # WSGI Configuration (same as HTTP)
    WSGIDaemonProcess youtube2mp3-ssl \
        user=www-data \
        group=www-data \
        threads=5 \
        python-home=/opt/youtube2mp3/venv \
        python-path=/opt/youtube2mp3 \
        home=/opt/youtube2mp3
    
    WSGIProcessGroup youtube2mp3-ssl
    WSGIScriptAlias / /opt/youtube2mp3/wsgi.py
    
    # WebSocket Proxy (for SocketIO over HTTPS)
    ProxyPreserveHost On
    
    # Allow access to WSGI script
    <Directory /opt/youtube2mp3>
        Require all granted
    </Directory>
    
    # Static files
    Alias /static /opt/youtube2mp3/static
    <Directory /opt/youtube2mp3/static>
        Require all granted
        Options -Indexes
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </Directory>
    
    # Downloads directory
    Alias /downloads /opt/youtube2mp3/downloads
    <Directory /opt/youtube2mp3/downloads>
        Require all granted
        Options -Indexes
        <FilesMatch "\.(mp3|m4a|ogg|opus|zip)$">
            Require all granted
        </FilesMatch>
    </Directory>
    
    # Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    
    LimitRequestBody 16777216
</VirtualHost>
</IfModule>
