# Apache Virtual Host Configuration with Gunicorn Backend
# This configuration uses Apache as a reverse proxy to Gunicorn
# RECOMMENDED for full WebSocket/SocketIO support
#
# Prerequisites:
# 1. Enable Apache modules: sudo a2enmod proxy proxy_http proxy_wstunnel headers rewrite
# 2. Install Gunicorn with eventlet: pip install gunicorn eventlet
# 3. Set up systemd service (see youtube2mp3.service)
# 4. Place this file in: /etc/apache2/sites-available/
# 5. Enable: sudo a2ensite youtube2mp3-gunicorn.conf
# 6. Reload: sudo systemctl reload apache2

<VirtualHost *:80>
    ServerName your-nas-hostname.local
    ServerAlias youtube2mp3.local
    
    # Optional: Redirect to HTTPS
    # RewriteEngine On
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/youtube2mp3_error.log
    CustomLog ${APACHE_LOG_DIR}/youtube2mp3_access.log combined
    LogLevel warn
    
    # Proxy to Gunicorn (running on localhost:8000)
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/
    
    # WebSocket support (for SocketIO)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://127.0.0.1:8000/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://127.0.0.1:8000/$1 [P,L]
    
    # ProxyPass for Socket.IO
    ProxyPass /socket.io http://127.0.0.1:8000/socket.io
    ProxyPassReverse /socket.io http://127.0.0.1:8000/socket.io
    
    # Enable WebSocket tunneling
    <Location /socket.io>
        ProxyPass http://127.0.0.1:8000/socket.io
        ProxyPassReverse http://127.0.0.1:8000/socket.io
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/?(.*) "ws://127.0.0.1:8000/$1" [P,L]
    </Location>
    
    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    
    # Request timeout (for long downloads)
    ProxyTimeout 300
    
    # Limit upload size (16MB)
    LimitRequestBody 16777216
</VirtualHost>

# HTTPS Configuration with Gunicorn Backend
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName your-nas-hostname.local
    ServerAlias youtube2mp3.local
    
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/youtube2mp3.crt
    SSLCertificateKeyFile /etc/ssl/private/youtube2mp3.key
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/youtube2mp3_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/youtube2mp3_ssl_access.log combined
    LogLevel warn
    
    # Proxy to Gunicorn
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/
    
    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://127.0.0.1:8000/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://127.0.0.1:8000/$1 [P,L]
    
    # Socket.IO proxy
    ProxyPass /socket.io http://127.0.0.1:8000/socket.io
    ProxyPassReverse /socket.io http://127.0.0.1:8000/socket.io
    
    <Location /socket.io>
        ProxyPass http://127.0.0.1:8000/socket.io
        ProxyPassReverse http://127.0.0.1:8000/socket.io
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/?(.*) "ws://127.0.0.1:8000/$1" [P,L]
    </Location>
    
    # Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    
    ProxyTimeout 300
    LimitRequestBody 16777216
</VirtualHost>
</IfModule>
